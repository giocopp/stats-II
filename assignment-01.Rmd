---
title: "Assignment 1 - The Potential Outcomes Framework and DAGs"
author: "GIORGIO COPPOLA"
date: "`r format(Sys.time(), '%B %d, %Y | %H:%M:%S | %Z')`"
output:
  html_document:
    #code_folding: hide
    df_print: paged
    highlight: tango
    number_sections: no
    theme: cosmo
    toc: no
  pdf_document:
    toc: no
---

```{=html}
<style>
div.answer {background-color:#f3f0ff; border-radius: 5px; padding: 20px;}
</style>
<style>
div.gradingadvice {background-color:#a2bc89; border-radius: 5px; padding: 20px;}
</style>
```
```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = TRUE,
                      error = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      comment = NA)
```

------------------------------------------------------------------------

```{r, include=F}
# LOAD PACKAGES HERE (PLEASE DON'T COPY IN CODE TO INSTALL PACKAGES)
pacman::p_load(tidyverse, ggdag, dagitty, magrittr)
```

### Task 1 - Does union membership affect workers' wages? [6 points in total]

A research group is interested in the effects that being part of a worker's union has on workers' wages. The researchers gathered the incomes of over 4,000 workers from years 2010 to 2017 in the U.S.

The researchers claim that being a member of a workers' union does not really affect a workers' income.

You are a bit skeptical of the results. Fortunately, you can observe the potential outcomes of over 4,000 workers under the two states of interest. In other words, you have data for the expected incomes of workers in a reality where they are part of a workers' union $(union = FALSE)$, as well as one where are not part of a workers' union $(union = TRUE)$.

The data\footnote{These are simulated data.} are stored in the `wages_union.rds` file and contain the following information:

-   `subject_id`: identification number for each worker
-   `union_memb`: binary marker for actual treatment state
-   `salary_0`: potential hourly salary under no union membership (union = FALSE)
-   `salary_1`: potential hourly salary under union membership (union = TRUE)
-   `observed_salary`: hourly salary observed in reality

<br>

```{r}
# loading the data:
setwd("/Users/giocopp/Library/Mobile Documents/com~apple~CloudDocs/Desktop/Unive/Hertie School/2nd Semester/Statistics 2/Labs/01-assignment")
wages_union <- readRDS("wages_union.rds")
View(wages_union)
head(wages_union, 10)

```

a)  **Extract the following quantities of interest with `dplyr` functions, rounding to two decimal places. If the output is more than a single number, provide the first ten elements (not the entire data frame!).**

-   **Individual treatment effects (ITEs) [0.5 points]**

wages_union_ite \<- wages_union %\>%

dplyr::mutate(ite = salary_1 - salary_0)

head(wages_union_ite, 10)

```{r}
# Put your code here
wages_union_ite <- wages_union %>%
  dplyr::mutate(ite = salary_1 - salary_0)

head(wages_union_ite, 10)

```

<br>

-   **Average treatment effect (ATE) [0.5 points]**

```{r}
# Put your code here
round(wages_union %>%
  dplyr::mutate(ite = salary_1 - salary_0) %>%
  dplyr::summarize(ate = mean(ite)), digits = 2)

```

<br>

-   **Average treatment effect for the treated (ATT) [0.5 points]**

```{r}
# Put your code here
round(wages_union %>%
  dplyr::mutate(ite = salary_1 - salary_0) %>%
  dplyr::filter(union_memb == TRUE) %>%
  dplyr::summarize(treatment_effect = mean(ite)), digits = 2)

```

<br>

-   **Average treatment effect for the control (ATC) [0.5 points]**

```{r}
# Put your code here
round(wages_union %>%
  dplyr::mutate(ite = salary_1 - salary_0) %>%
  dplyr::filter(union_memb == FALSE) %>%
  dplyr::summarize(control_effect = mean(ite)), digits = 2)

```

<br>

-   **Naive average treatment effect (NATE) [0.5 points]**

```{r}
# Put your code here
round(wages_union %>%
  dplyr::mutate(observed_salary = ifelse(union_memb == TRUE, salary_1, salary_0)) %>%
  dplyr::group_by(union_memb) %>%
  dplyr::summarize(nate = mean(observed_salary)), digits = 2)

```

$$Clarification: NATE = E(Y 1 | D = 1) âˆ’ E(Y 0 | D = 0) = 25.01 - 20.00 = 5.01$$

<br>

-   **Selection, or baseline, bias [0.5 points]**

```{r}
# Put your code here
baseline_df <- wages_union %>%
  group_by(union_memb) %>%
  summarize(y0 = mean(salary_0))

baseline_bias <- round(baseline_df$y0[baseline_df$union_memb == TRUE] - 
  baseline_df$y0[baseline_df$union_memb == FALSE], digits = 2)

baseline_bias

```

<br>

-   **Differential treatment effect, or heterogeneous treatment effect, bias [0.5 points]**

```{r}
# Put your code here
diff_df <- wages_union %>%
  mutate(ite = salary_1 - salary_0) %>%
  group_by(union_memb) %>%
  summarize(treat_eff = mean(ite))

prop_control <- prop.table(table(wages_union$union_memb))[1] 

diff_effect_bias <- prop_control * (diff_df$treat_eff[diff_df$union_memb == TRUE] -
                                      diff_df$treat_eff[diff_df$union_memb == FALSE])


round(diff_effect_bias, digits = 2)
```

<br>

b)  **Visualize the distribution of individual treatment effects using an appropriately specified density plot. Highlight the other treatment effects that you generated in (a) in the plot using vertical lines and text labels [3 points]**

```{r}
# Put your code here
wages_union_ite <- wages_union %>%
  dplyr::mutate(ite = salary_1 - salary_0)

labels <- data.frame(x = c(3.41, 6.94, 1.9),
                     y = c(0.05, 0.04, 0.06),
                     label = c("ATE", "ATT", "ATC"))
  
ggplot(wages_union_ite, aes(x = ite)) +
  geom_density(fill = "lightblue", alpha = 0.5, color = "darkblue") +
  geom_vline(xintercept = 3.41, color = "red") +
  geom_vline(xintercept = 6.94, color = "orange") + 
  geom_vline(xintercept = 1.9, color = "brown") + 
  geom_label(data = labels, aes(x = x, y = y, label = label),
             fill = "white", color = "black", size = 2.5) +
  labs(x = "salary difference", y = "frequence")

```

<br>

### Task 2 - Simulating a basic structural causal model in R [3 points in total]

**In R, it is straightforward to generate simulated data from a structural causal model. Famimiarize yourself with the R code below, then run it and show visually how weight and daily sleep in hours are related, treating sleep as the variable to be explained and putting it on the appropriate axis, but ignoring animal type. Employ a plot type that is appropriate given the variable types (raw data points should still be visible), and make sure that the plot is formatted nicely. Then, reproduce the plot, now also highlighting the role of the species in the causal model. [3 points]**

```{r}
set.seed(123)
animal <- rep(c("dog", "cat", "rabbit", "fish"), each = 500)

# weight in grams as a function of animal type
weight <- rnorm(500, 10000, 10000*.1) * (animal == "dog") + 
          rnorm(500, 5000, 5000*.1) * (animal == "cat") + 
          rnorm(500, 3000, 3000*.075) * (animal == "rabbit") + 
          rnorm(500, 500, 500*.05) * (animal == "fish")

# daily sleep in hours as a function of animal type
sleepDaily <- rnorm(500, 8, 8*.1) * (animal == "dog") + 
          rnorm(500, 10, 10*.1) * (animal == "cat") + 
          rnorm(500, 12, 12*.075) * (animal == "rabbit") + 
          rnorm(500, 14, 14*.05) * (animal == "fish")

dat <- data.frame(animal, weight, sleepDaily, stringsAsFactors = FALSE)

```

<br>

```{r, fig.height=6,fig.width=6}
# Put your code here
ggplot(dat, aes(x = weight, y= sleepDaily)) +
  geom_point(size = 0.5)+
  theme_minimal() +
  labs(x = "weight",
       y = "sleep")

```

```{r}
ggplot(dat, aes(x = weight, y= sleepDaily, color = animal)) +
  geom_point(size = 0.5)+
  theme_minimal() +
  labs(x = "weight",
       y = "sleep")
```

<br>

### Task 3 - Bad for him, bad for her, but good for everyone - wait what? [5 points in total]

A doctor takes a look at research data about a new drug that promises to reduce the risk of heart disease. As an outcome, the doctor measured if patients had a heart attack or not. She studies both the effect among female and male patients. The doctor did not randomize the treatment with the new drug, instead, patients were able to decide whether they want to take the treatment or not.

| Groups | Heart Attack & Drug | No Heart Attack & Drug | Heart Attack & No Drug | No Heart Attack & No Drug |
|--------|:-------------------:|:----------------------:|:----------------------:|:-------------------------:|
| Female |          3          |           21           |           5            |            42             |
| Male   |         11          |           33           |           6            |             9             |
| Total  |         13          |           47           |           11           |            49             |

```{r}
trial_data <- data.frame("Gender"=c("Female","Female","Male","Male"),
                         "Treatment"=c("Drug","NoDrug","Drug","NoDrug"),
                         "HeartAttack"=c(3,5,11,6),
                         "NoHeartAttack"=c(21,42,33,9))
head(trial_data)
```

<br>

a)  **What is the naive average treatment effect of taking the drug on having a heart attack for everyone? What is the naive treatment effect for female and male patients? [2 points]**

```{r}
# Put your code here

```

::: answer
Write your answer here
:::

<br>

b)  **Provide a DAG that helps explain why the drug seems to be bad for females, bad for males, but good for everyone. What kind of bias creates this reversal in the effect? [1 point]**

```{r}
# Put your code here
```

::: answer
Write your answer here
:::

<br>

c)  **How could you estimate the causal effect taking the information about both male and female patients into account? Explain and then provide an estimate! [2 points]**

::: answer
Write your answer here
:::

```{r}
# Put your code here
```

<br>

### Task 4 - Statistics inspired meme [1 bonus percentage point]

**Create a meme inspired by the topics of this assignment using R to earn one bonus point!**

```{r}
# Put your code here
```
